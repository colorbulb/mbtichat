rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // ============================================
    // HELPER FUNCTIONS
    // ============================================
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user is admin
    // MBTI Chat 2 uses isAdmin boolean field
    // Safely handles missing user documents
    function isAdmin() {
      return isAuthenticated() && 
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true;
    }
    
    // ============================================
    // USERS COLLECTION
    // ============================================
    // MBTI Chat 2: All authenticated users can read all profiles (for user discovery)
    match /users/{userId} {
      // All authenticated users can read any profile (required for user discovery)
      allow read: if isAuthenticated();
      
      // Users can create their own profile during registration
      allow create: if isAuthenticated() && request.auth.uid == userId;
      
      // Updates:
      // - Admins can update any user document
      // - A user can update their own document (for presence/profile changes) BUT
      //   cannot escalate privileges (cannot change isAdmin field)
      allow update: if
        isAdmin() ||
        (
          isAuthenticated() &&
          request.auth.uid == userId &&
          // Prevent privilege escalation: if isAdmin is in the update, it must match existing value
          // If it's not in the update (partial update), that's fine - we're not changing it
          (
            !('isAdmin' in request.resource.data) || 
            request.resource.data.isAdmin == resource.data.get('isAdmin', false)
          )
        );
      
      // Deletes: only admins can delete user documents
      allow delete: if isAdmin();
    }
    
    // ============================================
    // MBTI CHAT 2 PROJECT COLLECTIONS
    // ============================================
    
    // Chats collection - all authenticated users can read and write
    // Used for user-to-user conversations
    match /chats/{chatId} {
      allow read, write: if isAuthenticated();
      
      // Messages subcollection - all authenticated users can read and write
      // Used for individual messages within chats
      match /messages/{messageId} {
        allow read, write: if isAuthenticated();
      }
    }
    
    // Personality phrases - all authenticated users can read, admins can write
    // Used for MBTI-specific phrases
    match /personality_phrases/{mbti} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // System data - hobbies and red flags
    match /system_data/{document} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Audio questions - all authenticated users can read, admins can write
    match /audio_questions/{questionId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Dating categories - all authenticated users can read, admins can write
    match /dating_categories/{categoryId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Events - all authenticated users can read and write
    match /events/{eventId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated(); // Users can join events
      allow delete: if isAdmin();
    }
    
    // User action logs - users can create, admins can read
    match /user_action_logs/{logId} {
      allow create: if isAuthenticated();
      allow read: if isAdmin();
      allow update, delete: if false;
    }
    
    // ============================================
    // ADMIN TRACKING COLLECTIONS
    // ============================================
    
    // API calls tracking - authenticated users can create, admins can read
    match /api_calls/{callId} {
      allow create: if isAuthenticated();
      allow read: if isAdmin();
      allow update, delete: if false;
    }
    
    // Login history - authenticated users can create, admins can read
    match /login_history/{loginId} {
      allow create: if isAuthenticated();
      allow read: if isAdmin();
      allow update, delete: if false;
    }
    
    // Admin activities - admins can read/write
    match /admin_activities/{activityId} {
      allow read, write: if isAdmin();
    }

    // ============================================
    // ICEBREAKERS & CHAT STATS
    // ============================================

    // Icebreaker templates - all authenticated users can read, admins can write
    match /icebreaker_templates/{templateId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // Chat stats - used for conversation milestones
    // Any authenticated user can read/write for now (app enforces participant checks)
    match /chat_stats/{chatId} {
      allow read, write: if isAuthenticated();
    }
    
    // ============================================
    // GAMIFICATION COLLECTIONS
    // ============================================
    
    // Badge templates - all authenticated users can read, admins can write
    match /badge_templates/{templateId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Daily questions - all authenticated users can read, admins can write
    match /daily_questions/{questionId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Chat game templates - all authenticated users can read, admins can write
    match /chat_game_templates/{templateId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Super likes - authenticated users can read/write their own
    match /super_likes/{likeId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update, delete: if false;
    }
    
    // ============================================
    // DEFAULT DENY RULE
    // ============================================
    
    // Default: deny all other access
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
