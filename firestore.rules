rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // ============================================
    // HELPER FUNCTIONS
    // ============================================
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user is admin
    // Supports both projects: isAdmin (mbtichat2) and role='admin' (twoplayergame)
    function isAdmin() {
      return isAuthenticated() && 
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        (
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true ||
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin'
        );
    }
    
    // ============================================
    // USERS COLLECTION (Shared by both projects)
    // ============================================
    match /users/{userId} {
      // All authenticated users can read any profile (required for user discovery)
      allow read: if isAuthenticated();
      
      // Users can create their own profile during registration
      allow create: if isAuthenticated() && request.auth.uid == userId;
      
      // Updates:
      // - Admins can update any user document (including password reset)
      // - A user can update their own document BUT cannot escalate privileges
      allow update: if
        isAdmin() ||
        (
          isAuthenticated() &&
          request.auth.uid == userId &&
          // Prevent privilege escalation
          (
            (!('isAdmin' in request.resource.data) || 
             request.resource.data.isAdmin == resource.data.get('isAdmin', false)) &&
            (!('role' in request.resource.data) || 
             (request.resource.data.role == resource.data.get('role', 'user') &&
              request.resource.data.role != 'admin'))
          )
        );
      
      // Deletes: only admins can delete user documents
      allow delete: if isAdmin();
    }
    
    // ============================================
    // SHARED COLLECTIONS (Both projects)
    // ============================================
    
    // Chats collection
    match /chats/{chatId} {
      allow read, write: if isAuthenticated();
      
      match /messages/{messageId} {
        allow read, write: if isAuthenticated();
      }
    }
    
    // Personality phrases
    match /personality_phrases/{mbti} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // System data (hobbies, red flags)
    match /system_data/{document} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Audio questions
    match /audio_questions/{questionId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Dating categories
    match /dating_categories/{categoryId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Events
    match /events/{eventId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAdmin();
    }
    
    // User action logs
    match /user_action_logs/{logId} {
      allow create: if isAuthenticated();
      allow read: if isAdmin();
      allow update, delete: if false;
    }
    
    // ============================================
    // ADMIN TRACKING COLLECTIONS
    // ============================================
    
    // API calls tracking
    match /api_calls/{callId} {
      allow create: if isAuthenticated();
      allow read: if isAdmin();
      allow update, delete: if false;
    }
    
    // Login history
    match /login_history/{loginId} {
      allow create: if isAuthenticated();
      allow read: if isAdmin();
      allow update, delete: if false;
    }
    
    // Admin activities
    match /admin_activities/{activityId} {
      allow read, write: if isAdmin();
    }

    // ============================================
    // ICEBREAKERS & CHAT STATS
    // ============================================

    // Icebreaker templates
    match /icebreaker_templates/{templateId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // Chat stats
    match /chat_stats/{chatId} {
      allow read, write: if isAuthenticated();
    }
    
    // ============================================
    // GAMIFICATION COLLECTIONS
    // ============================================
    
    // Badge templates
    match /badge_templates/{templateId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Daily questions
    match /daily_questions/{questionId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Chat game templates
    match /chat_game_templates/{templateId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Super likes
    match /super_likes/{likeId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update, delete: if false;
    }
    
    // ============================================
    // GAME PLATFORM COLLECTIONS (twoplayergame only)
    // ============================================
    
    // Game rooms for multiplayer games
    match /game_rooms/{gameType}/{roomId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAdmin() || 
        (isAuthenticated() && resource.data.host == request.auth.uid);
    }
    
    // ============================================
    // DEFAULT DENY RULE
    // ============================================
    
    // Default: deny all other access
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
